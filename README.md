# Overview

This is a demonstration of a known issue of Android Studio as specified [here][theissue].

Simply speaking, when executing (non-Android) unit test in Android Studio, the non-Android resources in Java modules will not be available. So the following code will fail (return null) in unit test even when it is OK in real world.

```Java
InputStream is = getClass().getClassLoader().getResourceAsStream("path/to/resource.txt");
```

This issues affect non-Android unit test and Java resources, executing on Android Studio with "Unit Test" configuration only. It does not affect the execution of test cases with Gradle (in Android Studio or command line).

In the [issue tracker discussion][discussion] of Android Studio, a interim solution is given. It copy the Java resources from test source set to the class directory. However, it does not take into account that the Java resources may be in dependent modules of the same project. This project demonstrates the problem and propose a solution.

# Quick start [quickstart]

For those who can't wait to solve the problem, copy the file `setup-test-java-resources.gradle` to your module directory with problem. Then add the following line to your `build.gradle` file:

```
apply from: 'setup-test-java-resources.gradle'
```

Clean build the system again. Then the unit tests should be immune to the problem.

# Target system

This project is developed under Android Studio 1.3.2, with Android Gradle Plugin 1.3.0, on OSX 10.10.5. The IDE uses [Apple Java 6 2005-1][applejava]. The result for other combinations may be vary.

# Project structure

This Android project has two modules. One is the main application module ("app"). It is a vanilla project generated by the project wizard of Android Studio, with one "hello world" activity. The other module is ("lib"), which consists a simple class with Java resource.

 The "app" module has a POJO class (`HelloClient`) which invoke the code in module "lib". A unit test in the module attempt to execute the class, which in turn execute code in module "lib".

 The app should have no problem to build and deploy to real device. It shows an activity with message "Hello, John!". That's it.

 To execute the unit test, right click the `HelloClientTest` class in project explorer and select "Run 'HelloClientTest'". It is expected that the test will fail, due to the problem mentioned above. You should be able to see exception like this:

```
java.lang.NullPointerException
	at java.util.Properties$LineReader.readLine(Properties.java:434)
	at java.util.Properties.load0(Properties.java:353)
	at java.util.Properties.load(Properties.java:341)
	at ws2l.mrdemolib.Hello.getString(Hello.java:28)
	at ws2l.mrdemolib.Hello.hello(Hello.java:17)
	at ws2l.mrdemo.HelloClient.helloWithName(HelloClient.java:13)
	at ws2l.mrdemo.HelloClientTest.testHelloClient(HelloClientTest.java:16)
```

In order to fix the problem, see the Quick Start section above.

To try the project, just uncomment the corresponding line in build.gradle of "app" module is enough.

# How does it work

The solution works by copying all files within jar file of dependency modules, except .class files, to the test classes directory. It behave a little bit different depends on the dependency is an AAR file or JAR file. It also copy the Java resources in the test sourcesets, based on the technique described [here][solution1].

## JAR

All files except .class within the jar will be copied.

## AAR

The classes.jar of the AAR is extracted, and copy the files within that jar.

# License

```
Copyright 2015 Herman Cheung

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```

[theissue]: http://tools.android.com/knownissues#TOC-JUnit-tests-missing-resources-in-classpath-when-run-from-Studio
[discussion]: https://code.google.com/p/android/issues/detail?id=64887#c13
[applejava]: https://support.apple.com/kb/DL1572?locale=en_US
[solution1]: https://code.google.com/p/android/issues/detail?id=64887#c43